{% extends "base.html" %}
{% block content %}

<style>
.dashboard-container {
    padding: 30px 20px;
    max-width: 1100px;
    margin: auto;
}

.dashboard-title {
    font-size: 36px;
    font-weight: 700;
}

.dashboard-subtitle {
    color: #6b7280;
    margin-top: 6px;
}

.btn-main {
    margin-top: 20px;
    background: linear-gradient(90deg,#8b5cf6,#ec4899);
    color: white;
    padding: 16px;
    border-radius: 16px;
    font-size: 18px;
    text-align: center;
    display: block;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
    gap: 20px;
    margin-top: 30px;
}

.stat-card {
    background: white;
    border-radius: 18px;
    padding: 20px;
    display: flex;
    gap: 14px;
    align-items: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}

.stat-icon {
    width: 46px;
    height: 46px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.empty-state {
    margin-top: 80px;
    text-align: center;
}

.empty-icon {
    width: 90px;
    height: 90px;
    border-radius: 50%;
    background: linear-gradient(135deg,#8b5cf6,#ec4899);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: auto;
    color: white;
    font-size: 36px;
}

</style>

<div class="dashboard-container">

    <h1 class="dashboard-title">My Resumes</h1>
    <p class="dashboard-subtitle">
        Create and manage your ATS-optimized resumes
    </p>

    <a href="{% url 'create_resume' %}" class="btn-main">Ôºã New Resume</a>

    <!-- ATS SCORE CALCULATOR -->
    <form method="POST" enctype="multipart/form-data" style="margin-top:24px; padding:18px; border-radius:16px; background:#f9fafb; box-shadow:0 8px 24px rgba(0,0,0,0.04);">
        {% csrf_token %}
        <h2 style="font-size:20px; font-weight:600; margin-bottom:8px;">Calculate ATS Score</h2>
        <p style="color:#6b7280; margin-bottom:12px;">
            Upload a resume PDF and we'll estimate how ATS-friendly it is.
        </p>
        <input type="file" name="resume_pdf" accept="application/pdf" style="margin-bottom:12px;">
        <button type="submit" style="padding:10px 18px; border-radius:999px; border:none; background:linear-gradient(90deg,#8b5cf6,#ec4899); color:white; font-weight:600; cursor:pointer;">
            Calculate ATS Score
        </button>

        {% if ats_error %}
        <div style="margin-top:10px; color:#b91c1c; font-size:14px;">
            {{ ats_error }}
        </div>
        {% endif %}

        {% if ats_score_result is not None %}
        <div style="margin-top:12px; padding:10px 14px; border-radius:12px; background:#ecfdf5; color:#166534;">
            Estimated ATS Score: <strong>{{ ats_score_result }}%</strong>
        </div>
        {% endif %}
    </form>

    <!-- AI CAREER ANALYSIS -->
    <div style="margin-top:24px; padding:18px; border-radius:16px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); box-shadow:0 8px 24px rgba(0,0,0,0.1);">
        <h2 style="font-size:20px; font-weight:600; margin-bottom:8px; color:white;">ü§ñ AI Career Analysis</h2>
        <p style="color:rgba(255,255,255,0.9); margin-bottom:12px;">
            Upload your resume PDF and get AI-powered recommendations for top companies, hiring processes, and study resources.
        </p>
        <form id="ai-analysis-form" enctype="multipart/form-data" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            {% csrf_token %}
            <input type="file" id="ai-resume-pdf" name="resume_pdf" accept="application/pdf" required style="flex:1; min-width:200px; padding:10px; border-radius:8px; border:none;">
            <button type="submit" id="ai-analyze-btn" style="padding:10px 20px; border-radius:999px; border:none; background:white; color:#667eea; font-weight:600; cursor:pointer;">
                Analyze with AI
            </button>
        </form>
        <div id="ai-loading" style="display:none; margin-top:12px; color:white; font-size:14px;">
            ‚è≥ Analyzing your resume... This may take a moment.
        </div>
        <div id="ai-error" style="display:none; margin-top:12px; padding:10px; border-radius:8px; background:rgba(255,0,0,0.2); color:white; font-size:14px;"></div>
        <div id="ai-results" style="display:none; margin-top:20px;"></div>
    </div>

    <!-- STATS -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background:#8b5cf6;">üìÑ</div>
            <div>
                <small>Total Resumes</small>
                <h2>{{ total_resumes }}</h2>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background:#06b6d4;">üéØ</div>
            <div>
                <small>Avg ATS Score</small>
                <h2>{{ avg_ats }}%</h2>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background:#ec4899;">‚è∞</div>
            <div>
                <small>Last Updated</small>
                <h2>
    {% if last_updated %}
        {{ last_updated.created_at|date:"M d, Y" }}
    {% else %}
        N/A
    {% endif %}
</h2>

            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background:#22c55e;">üìà</div>
            <div>
                <small>Analyzed</small>
                <h2>{{ analyzed_count }}</h2>
            </div>
        </div>
    </div>

    <!-- EMPTY STATE -->
    {% if total_resumes == 0 %}
    <div class="empty-state">
        <div class="empty-icon">üìÑ</div>
        <h2 style="margin-top:20px;">No resumes yet</h2>
        <p style="color:#6b7280;">
            Create your first resume and start landing interviews!
        </p>
        <a href="{% url 'create_resume' %}" class="btn-main" style="max-width:350px;margin:auto;margin-top:20px;">
            Ôºã Create Your First Resume
        </a>
    </div>
    {% endif %}

</div>

<script>
document.getElementById('ai-analysis-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('ai-resume-pdf');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    if (!fileInput.files[0]) {
        alert('Please select a PDF file');
        return;
    }
    
    formData.append('resume_pdf', fileInput.files[0]);
    
    const loadingDiv = document.getElementById('ai-loading');
    const errorDiv = document.getElementById('ai-error');
    const resultsDiv = document.getElementById('ai-results');
    const analyzeBtn = document.getElementById('ai-analyze-btn');
    
    // Show loading, hide error/results
    loadingDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    resultsDiv.style.display = 'none';
    analyzeBtn.disabled = true;
    analyzeBtn.textContent = 'Analyzing...';
    
    try {
        const response = await fetch('{% url "ai_resume_analysis" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        });
        
        const data = await response.json();
        
        loadingDiv.style.display = 'none';
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'Analyze with AI';
        
        if (!response.ok) {
            throw new Error(data.error || 'Analysis failed');
        }
        
        // Redirect to results page if successful
        if (data.success && data.redirect_url) {
            window.location.href = data.redirect_url;
            return;
        }
        
        // Fallback: Display results inline (for backward compatibility)
        if (data.top_companies && data.top_companies.length > 0) {
            let html = '<div style="background:white; padding:20px; border-radius:12px; margin-top:15px;">';
            html += '<h3 style="font-size:18px; font-weight:600; margin-bottom:15px; color:#1f2937;">Top 10 Company Recommendations</h3>';
            
            data.top_companies.forEach((company, index) => {
                html += `<div style="margin-bottom:20px; padding:15px; border:1px solid #e5e7eb; border-radius:10px; background:#f9fafb;">`;
                html += `<h4 style="font-size:16px; font-weight:600; color:#667eea; margin-bottom:5px;">${index + 1}. ${company.name}</h4>`;
                html += `<p style="color:#6b7280; margin-bottom:8px;"><strong>Location:</strong> ${company.location || 'Not specified'}</p>`;
                html += `<p style="color:#374151; margin-bottom:8px;"><strong>Why this company:</strong> ${company.match_reason || 'Good match based on your profile'}</p>`;
                html += `<div style="margin-bottom:8px;"><strong style="color:#374151;">Hiring Process:</strong><ol style="margin-left:20px; color:#4b5563;">`;
                if (company.hiring_process) {
                    const steps = company.hiring_process.split(/\d+\./).filter(s => s.trim());
                    steps.forEach(step => {
                        if (step.trim()) {
                            html += `<li style="margin-bottom:4px;">${step.trim()}</li>`;
                        }
                    });
                }
                html += `</ol></div>`;
                html += `<div><strong style="color:#374151;">Study Resources:</strong><ul style="margin-left:20px; color:#4b5563;">`;
                if (company.study_resources && Array.isArray(company.study_resources)) {
                    company.study_resources.forEach(resource => {
                        html += `<li style="margin-bottom:4px;">${resource}</li>`;
                    });
                }
                html += `</ul></div>`;
                html += `</div>`;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        } else {
            throw new Error('No company recommendations received');
        }
    } catch (error) {
        loadingDiv.style.display = 'none';
        errorDiv.textContent = 'Error: ' + error.message;
        errorDiv.style.display = 'block';
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'Analyze with AI';
    }
});
</script>

{% endblock %}
